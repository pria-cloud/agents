# GitHub Integration System Documentation

## Overview

The PRIA App Builder includes a comprehensive GitHub integration system that enables seamless code synchronization between E2B sandboxes (Target Apps) and GitHub repositories. This system provides advanced features including conflict detection, multiple sync strategies, and automated setup.

## Architecture

### Component Hierarchy

```
GitHub Integration System
├── Authentication Layer
│   ├── GitHub OAuth/Token Authentication
│   ├── Token Encryption & Storage
│   └── Workspace-Level Access Control
├── Repository Management
│   ├── Repository Creation & Configuration
│   ├── Branch Management
│   └── Access Permissions
├── E2B Sandbox Integration
│   ├── Git Installation & Configuration
│   ├── GitHub CLI Setup
│   └── SSH Key Generation
├── Advanced Sync Engine
│   ├── Intelligent Change Detection
│   ├── Conflict Resolution
│   ├── Multiple Sync Strategies
│   └── Operation Tracking
└── User Interface
    ├── Authentication Flow
    ├── Repository Management UI
    ├── Advanced Sync Options
    └── Operation Monitoring
```

## Core Services

### 1. GitHubIntegrationService

**Location**: `lib/services/github-integration.ts`

Handles GitHub API operations using the Octokit SDK.

#### Key Features:
- Repository creation and management
- File operations (create, update, delete)
- Branch operations
- Pull request creation
- Organization and user management

#### Usage Example:
```typescript
const github = new GitHubIntegrationService({ accessToken: 'token' })
const repo = await github.createRepository('my-app', {
  description: 'Generated by PRIA',
  private: true
})
```

### 2. E2BGitHubSetupService

**Location**: `lib/services/e2b-github-setup.ts`

Configures GitHub access within E2B sandboxes.

#### Key Features:
- Git installation and configuration
- GitHub authentication setup
- SSH key generation
- GitHub CLI installation
- Repository cloning

#### Usage Example:
```typescript
const setupResult = await E2BGitHubSetupService.setupGitHubInSandbox(sandbox, {
  sessionId,
  workspaceId,
  sandboxId,
  githubToken: 'token',
  repositoryUrl: 'https://github.com/user/repo.git'
})
```

### 3. GitHubCodeSyncService

**Location**: `lib/services/github-code-sync.ts`

Advanced synchronization engine with intelligent change detection and conflict resolution.

#### Key Features:
- **Intelligent Change Detection**: Parses git status with porcelain format
- **Multiple Sync Strategies**: Merge, rebase, reset options
- **Conflict Detection**: Identifies and reports merge conflicts
- **Pattern Matching**: Include/exclude file patterns
- **Operation Tracking**: Complete audit trail of sync operations
- **Local Backup**: Automatic backup before destructive operations

#### Push Features:
```typescript
const result = await codeSync.pushToGitHub('Commit message', {
  createPullRequest: true,
  targetBranch: 'main',
  skipEmptyCommit: true,
  includePatterns: ['src/**', 'lib/**'],
  excludePatterns: ['node_modules/**', '.env*']
})
```

#### Pull Features:
```typescript
const result = await codeSync.pullFromGitHub({
  strategy: 'merge', // 'merge' | 'rebase' | 'reset'
  resolveConflicts: false,
  backupLocal: true
})
```

## Database Schema

### GitHub Authentication (`github_auth`)

```sql
CREATE TABLE github_auth (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  access_token TEXT NOT NULL, -- Encrypted
  github_username TEXT NOT NULL,
  github_email TEXT,
  scopes TEXT[], -- GitHub token scopes
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### GitHub Repositories (`github_repositories`)

```sql
CREATE TABLE github_repositories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id),
  session_id UUID NOT NULL REFERENCES sessions(id),
  github_id BIGINT NOT NULL, -- GitHub repository ID
  name TEXT NOT NULL,
  full_name TEXT NOT NULL, -- owner/name
  owner TEXT NOT NULL,
  html_url TEXT NOT NULL,
  clone_url TEXT NOT NULL,
  default_branch TEXT DEFAULT 'main',
  private BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### GitHub Sync Status (`github_sync_status`)

```sql
CREATE TABLE github_sync_status (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id),
  session_id UUID NOT NULL REFERENCES sessions(id),
  repository_owner TEXT NOT NULL,
  repository_name TEXT NOT NULL,
  sync_type TEXT NOT NULL, -- 'push' | 'pull' | 'setup'
  sync_status TEXT NOT NULL, -- 'success' | 'failed' | 'partial'
  files_added INTEGER DEFAULT 0,
  files_modified INTEGER DEFAULT 0,
  files_deleted INTEGER DEFAULT 0,
  commit_shas TEXT[], -- Array of commit SHAs
  error_messages TEXT[],
  synced_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

## API Endpoints

### Authentication Endpoints

#### `POST /api/github/auth`
Authenticate with GitHub using personal access token.

**Request Body:**
```json
{
  "action": "authenticate",
  "accessToken": "github_token_here"
}
```

**Response:**
```json
{
  "success": true,
  "user": {
    "login": "username",
    "name": "User Name",
    "email": "user@example.com"
  }
}
```

#### `GET /api/github/auth`
Check current GitHub authentication status.

**Response:**
```json
{
  "authenticated": true,
  "github_username": "username"
}
```

### Setup Endpoints

#### `POST /api/github/setup`
Setup GitHub access in E2B sandbox.

**Request Body:**
```json
{
  "action": "setup",
  "sessionId": "session_id",
  "sandboxId": "sandbox_id",
  "repositoryUrl": "https://github.com/user/repo.git",
  "branch": "main"
}
```

**Actions:**
- `setup`: Complete GitHub setup
- `check_setup`: Verify setup status
- `verify_connection`: Test GitHub connectivity
- `install_tools`: Install development tools
- `create_project_structure`: Create PRIA project structure

### Sync Endpoints

#### `POST /api/github/sync`
Perform GitHub synchronization operations.

**Push Request:**
```json
{
  "action": "push_to_github",
  "sessionId": "session_id",
  "sandboxId": "sandbox_id",
  "commitMessage": "Update target app",
  "branch": "main",
  "createPullRequest": false,
  "skipEmptyCommit": true,
  "excludePatterns": ["node_modules/**", ".env*"]
}
```

**Pull Request:**
```json
{
  "action": "pull_from_github",
  "sessionId": "session_id",
  "sandboxId": "sandbox_id",
  "branch": "main",
  "strategy": "merge",
  "resolveConflicts": false,
  "backupLocal": true
}
```

#### `GET /api/github/sync`
Query GitHub sync information.

**Query Parameters:**
- `sessionId`: Session identifier
- `action`: `repository` | `sync_history` | `repositories`

## User Interface Components

### TargetAppGitHubSync Component

**Location**: `components/github/target-app-github-sync.tsx`

Main UI component for GitHub integration.

#### Features:
- **Authentication Flow**: Token-based GitHub authentication
- **Repository Management**: Create and link repositories
- **Sandbox Setup**: Configure GitHub access in E2B
- **Advanced Sync Options**: Multiple strategies and conflict handling
- **Operation Monitoring**: Real-time sync status and history

#### Props:
```typescript
interface TargetAppGitHubSyncProps {
  sessionId: string
  workspaceName: string
  projectName: string
  sandboxId?: string
  className?: string
}
```

#### State Management:
- Authentication status and user info
- Repository information and status
- Sync operation history and current state
- Conflict detection and resolution
- Advanced options toggle

## Advanced Features

### 1. Intelligent Change Detection

The system uses git's porcelain format to detect file changes:

```typescript
// Detects: added, modified, deleted, renamed files
const statusResult = await sandbox.process.startAndWait(
  `cd ${projectPath} && git status --porcelain=v2`
)
```

### 2. Conflict Resolution

Multiple strategies for handling merge conflicts:

- **Merge**: Standard git merge (default)
- **Rebase**: Rebase local changes on top of remote
- **Reset**: Hard reset to remote state (destructive)

### 3. Pattern Matching

Support for include/exclude patterns:

```typescript
// Include only source files
includePatterns: ['src/**', 'lib/**', 'components/**']

// Exclude generated and sensitive files
excludePatterns: ['node_modules/**', '.next/**', '.env*', 'dist/**']
```

### 4. Operation Tracking

Complete audit trail with detailed operation information:

```typescript
interface SyncOperation {
  id: string
  type: 'push' | 'pull'
  status: 'pending' | 'running' | 'completed' | 'failed' | 'conflict'
  startTime: Date
  endTime?: Date
  changes: FileChangeInfo[]
  conflicts?: ConflictInfo[]
  commit?: CommitInfo
  errors?: string[]
}
```

## Security Considerations

### 1. Token Encryption

GitHub tokens are encrypted before storage:

```typescript
// Encrypt token before storage
const encryptedToken = Buffer.from(token).toString('base64')

// Decrypt token before use
const decryptedToken = Buffer.from(encryptedToken, 'base64').toString('utf-8')
```

**Note**: In production, use proper encryption with a key management service.

### 2. Workspace Isolation

All GitHub resources are isolated by workspace:

```sql
-- All queries include workspace filtering
SELECT * FROM github_auth WHERE workspace_id = $1;
SELECT * FROM github_repositories WHERE workspace_id = $1;
```

### 3. Limited Scope Access

GitHub tokens should be created with minimal required scopes:

- `repo` - Repository access
- `user:email` - User email access
- `workflow` - GitHub Actions (if needed)

## Workflow Integration

### Phase-Based Synchronization

The GitHub integration aligns with PRIA's 7-phase workflow:

1. **Requirements Gathering**: No sync needed
2. **Architecture Design**: Sync design documents
3. **Implementation Planning**: Sync planning artifacts
4. **Development**: Continuous code sync
5. **Testing**: Sync test files and results
6. **Validation**: Sync security reports
7. **Deployment**: Final sync before deployment

### Automated Integration

The system can be configured for automatic sync at phase transitions:

```typescript
// Auto-sync on phase completion
await workflowManager.onPhaseComplete(async (phase) => {
  if (phase >= 4) { // Development phase and beyond
    await githubSync.pushToGitHub(`Phase ${phase} completion`)
  }
})
```

## Error Handling

### Common Error Scenarios

1. **Authentication Failures**
   - Invalid or expired tokens
   - Insufficient permissions
   - Rate limiting

2. **Repository Issues**
   - Repository not found
   - Access denied
   - Branch protection rules

3. **Sync Conflicts**
   - Merge conflicts
   - File permission issues
   - Network connectivity

### Error Recovery

The system implements comprehensive error handling:

```typescript
try {
  const result = await codeSync.pushToGitHub(message, options)
  if (!result.success) {
    // Handle specific error cases
    if (result.operation.conflicts?.length > 0) {
      // Handle conflicts
    }
  }
} catch (error) {
  // Handle network/system errors
  logger.error('Sync failed:', error)
}
```

## Performance Optimization

### 1. Incremental Sync

Only sync changed files to minimize transfer time:

```typescript
// Detect only changed files
const changes = await this.detectFileChanges(projectPath, options)
if (changes.length === 0 && options.skipEmptyCommit) {
  return // Skip unnecessary sync
}
```

### 2. Parallel Operations

Multiple sync operations can run concurrently:

```typescript
// Parallel processing support
const operations = await Promise.all([
  codeSync1.pushToGitHub(message1),
  codeSync2.pushToGitHub(message2)
])
```

### 3. Caching

Repository information and setup status are cached to reduce API calls.

## Monitoring and Analytics

### Sync Metrics

Track sync performance and success rates:

- Total sync operations
- Success/failure rates
- Average sync duration
- File change statistics
- Conflict frequency

### Database Queries

Monitor sync activity:

```sql
-- Sync success rate by session
SELECT 
  session_id,
  COUNT(*) as total_syncs,
  COUNT(*) FILTER (WHERE sync_status = 'success') as successful_syncs,
  AVG(files_added + files_modified + files_deleted) as avg_files_changed
FROM github_sync_status 
WHERE workspace_id = $1 
GROUP BY session_id;
```

## Best Practices

### 1. Repository Structure

Recommended repository structure for PRIA target apps:

```
target-app/
├── .github/
│   └── workflows/
├── app/                 # Next.js app directory
├── components/          # React components
├── lib/                # Utility libraries
├── supabase/           # Database migrations
├── public/             # Static assets
├── .env.example        # Environment template
├── package.json
├── next.config.js
└── README.md
```

### 2. Commit Messages

Use descriptive commit messages:

```
feat: Add user authentication system
fix: Resolve database connection timeout
docs: Update API documentation
test: Add integration tests for user service
```

### 3. Branch Strategy

Recommended branching strategy:

- `main`: Production-ready code
- `develop`: Integration branch
- `feature/*`: Feature development
- `hotfix/*`: Critical fixes

### 4. Conflict Prevention

Minimize conflicts by:

- Regular pulls before pushing
- Atomic commits (single concern)
- Clear file ownership in teams
- Automated formatting/linting

## Troubleshooting

### Common Issues

#### 1. Authentication Failures

**Problem**: GitHub authentication fails
**Solution**: 
- Verify token validity
- Check token scopes
- Regenerate token if expired

#### 2. Repository Access Denied

**Problem**: Cannot access repository
**Solution**:
- Verify repository exists
- Check user permissions
- Ensure correct repository URL

#### 3. Merge Conflicts

**Problem**: Pull operation fails due to conflicts
**Solution**:
- Use conflict resolution UI
- Manual conflict resolution
- Reset strategy as last resort

#### 4. Sandbox Setup Issues

**Problem**: GitHub setup fails in E2B sandbox
**Solution**:
- Check sandbox connectivity
- Verify git installation
- Retry setup with fresh sandbox

### Debug Commands

Enable debug logging:

```typescript
// Enable debug logging
process.env.GITHUB_DEBUG = 'true'

// Check git status in sandbox
await sandbox.process.startAndWait('git status --porcelain=v2')

// Verify GitHub connectivity
await sandbox.process.startAndWait('curl -s https://api.github.com')
```

## Future Enhancements

### Planned Features

1. **GitHub Actions Integration**
   - Automatic deployment workflows
   - Test automation
   - Security scanning

2. **Advanced Conflict Resolution**
   - Visual conflict resolution UI
   - Intelligent merge suggestions
   - Automated resolution strategies

3. **Webhook Integration**
   - Real-time sync notifications
   - Automatic pull on remote changes
   - CI/CD integration

4. **Team Collaboration**
   - Multi-user repository access
   - Code review integration
   - Access control management

5. **Performance Enhancements**
   - Selective file sync
   - Compression optimization
   - Background sync operations

## Conclusion

The PRIA GitHub Integration System provides a comprehensive solution for synchronizing target app code between E2B sandboxes and GitHub repositories. With advanced features like intelligent change detection, conflict resolution, and operation tracking, it ensures reliable and efficient code management throughout the development workflow.

The system's modular architecture allows for easy extension and customization, while its robust error handling and security measures ensure production-ready reliability.