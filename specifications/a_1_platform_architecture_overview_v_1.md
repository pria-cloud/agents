# A1 — PRIA Platform Architecture Overview

**Document status:** Final v1.3 · June 2025\
**Owner:** CEO (Per Swedenborg)

**Purpose:** Capture the complete, end‑to‑end architecture of PRIA—including the **Google A2A Agent‑to‑Agent Gateway**, the **MCP (Multi‑Agent Conversation Protocol) Orchestrator**, and the **Admin Console ⇄ Agent Mesh self‑service loop** that generates fully‑isolated workspace apps (Next.js UI + Supabase tables + Cortex workflows) on demand.  Supabase is the single backend for **database**, **Edge Functions**, **Realtime**, and **Auth**; NextAuth has been removed.  This document is **only** about the internal **Admin Console**, not the customer‑facing workspace apps the agents create.

---

## Table of Contents

1. Scope & Objectives
2. System Context Diagram
3. Trust Boundaries & STRIDE Threat Model
4. Data‑Flow Matrix
5. Core Component Responsibilities\
       5.1 Next.js Front‑End (Vercel)\
       5.2 Supabase (Postgres 16 + Edge)\
       5.3 Admin Console & Self‑Service Loop\
       5.4 Cortex Workflow Orchestrator\
       5.5 Worker Pool\
       5.6 Python Agent Mesh\
       5.7 Agent Mesh A2A Gateway\
       5.8 Observability Plane
6. Deployment Topologies
7. Step‑by‑Step Bootstrapping
8. Open Items / TBD
9. Revision History

---

## 1  Scope & Objectives

1. Provide a single canonical description of PRIA's architecture—including A2A, MCP, and the Admin Console ⇄ Agent Mesh build loop.
2. Make **Supabase** usage explicit for database, Edge Functions, Realtime, and Auth.
3. Highlight that customer workspace apps are generated by agents and live in separate repos; this spec covers **only** the internal Admin Console.
4. Define trust boundaries and feed inputs to the Security spec (S1).
5. Supply enough detail that an engineer can reproduce the minimal Pilot‑tier deployment—including the `a2a-router`—using IaC.

---

## 2  System Context Diagram *(textual)*

Primary clouds: **Vercel** (edge runtime + micro‑frontends), **Supabase** (Postgres 16 with RLS, Edge Functions, Realtime, Auth), **Fly.io** (micro‑services, GPU pools), **Grafana Cloud** (metrics/logs/traces).

```
Browser / Admin User
    │ HTTPS (TLS 1.3) + Supabase JWT
    ▼
Vercel Edge ─────────────────────────────────────────────────────────────┐
    │  • Next.js 15 Admin Console (App Router)                           │
    │  • Micro‑frontend shell (module federation)                        │
    │  • POST /a2a/intent  (create workspace app, etc.)                  │
    ▼                                                                  │
Supabase Edge Functions ── LISTEN/NOTIFY ──┐                            │  Postgres 16  (RLS)
    │   pgmq JSON tasks                    │                            │
    ▼                                      │                            │
Cortex Orchestrator                        │                            │
    │   gRPC TaskLease                     │                            │
    ▼                                      │                            │
Worker Pool (Rust)                     Python Agent Mesh (Fly.io)        │
                                         │  gRPC (capability invocations)│
                                         ▼                              │
                                A2A Router (Go, Fly.io)                 │
                                         │ gRPC                         │
                                         ▼                              │
                         External / Partner Agents                      │
                                         │                              │
Grafana Cloud  ← OTLP metrics/logs/traces from every component ←─────────┘
```

The **Admin Console** lets an admin request a new supplier portal, for example.  That request is posted to `/a2a/intent` → routed to a bundle of agents (Composer Agent, Schema Synthesiser, UI Builder).  The bundle:

1. Extends the Supabase schema (Edge Function DSL + DDL).
2. Generates Next.js micro‑frontend code and commits to the client's workspace repo.
3. Creates/updates workflow DSL and fixtures.
4. Opens draft PRs; CI (C1) runs unit/integration/Playwright/W3 harness tests against a *Preview* schema.
5. Admin reviews Preview; upon approval, merges PR which auto‑deploys to production.
6. Rollback is a one‑click PR that reverts schema + code.

---

## 3  Trust Boundaries & STRIDE Threat Model

Boundary table unchanged from v1.2 except rows 6–7 (A2A Gateway & Admin Console loops) already included.

---

## 4  Data‑Flow Matrix *(new flows bold)*

| Flow ID   | Source → Sink               | Protocol      | Sensitive Data          | Data Class | Notes                             |
| --------- | --------------------------- | ------------- | ----------------------- | ---------- | --------------------------------- |
| DF‑01     | Browser → Vercel Edge       | HTTPS 1.3     | Supabase JWT            | Restricted | Supabase Auth issues JWT          |
| DF‑02     | Edge → Supabase Edge Fn     | HTTPS → pgmq  | Business rows           | Internal   | RLS enforced                      |
| DF‑03     | Supabase → Orchestrator     | LISTEN / pgmq | Task payload            | Internal   | queue depth alert                 |
| DF‑04     | Orchestrator → Worker       | gRPC (mTLS)   | Step params             | Internal   | deadline 5 s                      |
| **DF‑09** | Admin Console → A2A Router  | HTTPS → gRPC  | Intent JSON + workspace | Internal   | `build_app`, `rollback_app`, etc. |
| **DF‑10** | Agent Mesh → GitHub Actions | HTTPS         | Generated code          | Internal   | OIDC short‑lived token            |

---

## 5  Core Component Responsibilities

### 5.1  Next.js Front‑End (Vercel)

- Admin Console lives under `/admin/*` routes and is **not** delivered to customer workspaces.
- Uses Supabase **Auth**, **Edge Functions**, **Realtime**—NextAuth is **removed**.
- Emits OTEL metric `admin_build_request_total{status="requested|success|failed"}`.
- Renders generated micro‑frontends via **module federation**; shell loads remote entry for each workspace app.

### 5.2  Supabase (Postgres 16 + Edge)

- Canonical data store for **all** shared and tenant‑level tables; every workspace row carries `workspace_id` RLS.
- Edge Functions host REST facades for schema synthesis (`/schema/synthesise`) and A2A intent fallbacks.
- Realtime broadcast channels used by Admin Console to update build status live.

### 5.3  Admin Console & Self‑Service Loop

| Step | Actor / Component         | Action                                                                                         |
| ---- | ------------------------- | ---------------------------------------------------------------------------------------------- |
| 1    | Admin Console UI          | POST `/a2a/intent` `{kind:"build_app", app_meta}`                                              |
| 2    | A2A Router                | Routes to `Composer Agent` (capability `can_handle:app.compose`).                              |
| 3    | Composer Agent            | Drafts UI skeleton + workflow stubs; emits sub‑intents to `Schema Synthesiser` & `UI Builder`. **All schema and workflow changes are always delegated to the respective agents via sub-intents; never direct mutation.** |
| 4    | Schema Synthesiser Agent  | Generates DDL + pgTAP; opens PR to `infra/db` repo; posts back status via Realtime.            |
| 5    | UI Builder Agent          | Generates React/Tailwind micro‑frontend; opens PR to `web-{workspace}` repo.                   |
| 6    | CI Pipeline (C1)          | Runs full test suite; deploys Preview to Vercel branch URL, temp DB schema.                    |
| 7    | Admin reviews + merges PR | Merge triggers auto‑deploy to Pilot; nav updates.                                              |
| 8    | Rollback                  | Revert commits + `supabase db revert_schema` launched via Edge Fn.                             |

**The best-practice catalogue is a core component: all apps are classified as domain or custom, and domain apps must use shared models, workflows, and UI definitions.**

**All generated apps must use the correct Supabase workspace, RLS, and Auth.**

### 5.4  Cortex Workflow Orchestrator

- Executes DAGs stored in `workflow_def` (see W1); now adds `mcp_handoff_count` to every event.

### 5.5  Worker Pool

- Rust service executing deterministic `sql`, `http`, `script`, `branch`, `sleep` steps.
- Publishes OTEL span linking back to Orchestrator parent span.

### 5.6  Python Agent Mesh

- Hosts multiple fine‑tuned GPT‑4o adapters.  Each agent registers capabilities at startup via `/agents/register`.
- Hot‑reloads adapter weights nightly (ML1 pipeline).

### 5.7  Agent Mesh A2A Gateway

- Go service implementing Google A2A spec v0.9 and MCP.  Routes intents round‑robin to in‑mesh or external agents.
- Metrics: `a2a_intent_request_total`, `a2a_handoff_latency_ms`.

### 5.8  Observability Plane (Grafana Cloud)

- **Dashboards**\
    – *System Overview* (error heatmap, p95 latency)\
    – *Self‑Service Builds* (request count, success rate, avg build time)
- **Alerts**\
    – `a2a_intent_failure_total > 1 / 5m` → PagerDuty P1\
    – `admin_build_request_total{status="failed"} > 2 / 10m` → PagerDuty P2

---

## 6  Deployment Topologies

| Tier     | Supabase Plan | Vercel Plan | Fly Apps (CPU)                                       | GPU Pool           | Max Tenants |
| -------- | ------------- | ----------- | ---------------------------------------------------- | ------------------ | ----------- |
| Pilot    | Medium        | Pro         | 3× c3.large (cortex/worker/mesh) + 1× c3.small (A2A) | Spot A10G (1)      | 50          |
| Growth   | Large         | Pro         | 6× c3.large + 1× c3.medium (A2A)                     | Spot A10G (1)      | 500         |
| Scale‑Up | XL            | Enterprise  | 12× c3.large + 2× c3.medium (A2A HA)                 | On‑demand A10G (2) | 5,000       |

---

## 7  Step‑by‑Step Bootstrapping (Pilot)

1. **Clone Infra Repo** – `git clone git@github.com:pria-cloud/infra.git && cd infra`
2. **Bootstrap** – `make bootstrap env=pilot supabase_token=$SUPA vercel_token=$VERC fly_token=$FLY`
3. **Verify** – `curl https://agents.pilot.pria.cloud/healthz` → `{ "status": "ok" }`
4. **Smoke Build** – `make smoke-build-app workspace=test_ws name="hello_world"`\
      *Expect Vercel Preview URL and green CI.*

---

## 8  Open Items / TBD

- Decide between **GraphQL sub-schema stitching** vs **module federation** for runtime micro‑frontend loading.
- Add **code‑review LLM bot** to comment on agent‑generated PRs.
- Implement **time‑boxed sandbox** for agents to avoid runaway generation loops.
- Evaluate **EdgeDB** or **Neon branching** for Preview DB instead of temp schema.

---

## 9  Revision History

| Version | Date       | Author         | Notes                                                                            |
| ------- | ---------- | -------------- | -------------------------------------------------------------------------------- |
| 1.3     | 2025‑06‑14 | Per Swedenborg | Full regeneration incl. Supabase Edge Fn/Auth clarity, complete 5.x subsections. |
| 1.2     | 2025‑06‑14 | Per Swedenborg | Added Admin Console ⇄ Agent Mesh loop, DF‑09/10.                                 |
| 1.1     | 2025‑06‑14 | Per Swedenborg | Added A2A/MCP components and gateway sections.                                   |
| 1.0     | 2025‑06‑12 | Per Swedenborg | Original Final release.                                                          |

